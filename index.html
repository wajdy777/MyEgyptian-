
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>موسوعة الحضارة المصرية</title>
  <style>
    /* GENERAL STYLES */
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", Arial, sans-serif;
      direction: rtl;
      background-color: #f5f5f5;
      color: #333;
      transition: background-color 0.5s, color 0.5s;
    }
    /* FIXED TOP NAVIGATION BAR */
    .top-bar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background-color: #2a4d69;
      color: white;
      padding: 15px 0;
      border-bottom: 4px solid #007acc;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      animation: slideInDown 0.8s;
    }
    @keyframes slideInDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    /* OLD-STYLE BUTTONS */
    .old-style-button {
      background-color: #e0e0e0;
      border: 2px outset #999;
      color: #000;
      font-family: "Courier New", monospace;
      padding: 8px 16px;
      margin: 5px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
      outline: none;
    }
    .old-style-button:active {
      border-style: inset;
    }
    .top-bar button:hover {
      background-color: #d0d0d0;
      transform: scale(1.05);
    }
    /* SECTION STYLING */
    .section {
      display: none;
      padding: 20px;
      margin-top: 80px;
      animation: fadeIn 0.5s;
    }
    .section.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* APP SECTION STYLING */
    #app {
      background-color: #f9f9f9;
      color: #333;
      text-align: center;
      padding: 20px;
      position: relative;
    }
    #app header {
      padding: 20px;
      background-color: #2a4d69;
      color: white;
      position: relative;
      animation: fadeInDown 0.8s;
    }
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #app header h1 {
      font-size: 2.5em;
      margin: 0;
    }
    #app header p {
      font-size: 1.2em;
      margin-top: 10px;
      color: #d1ecf1;
    }
    /* Theme Toggle Button */
    #themeToggle {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px;
      font-size: 1.8em;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      background-color: transparent;
      color: white;
      transition: transform 0.5s;
      outline: none;
    }
    #themeToggle:hover {
      transform: rotate(360deg);
    }
    /* Settings Gear */
    #settingsToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px;
      font-size: 1.8em;
      border: none;
      cursor: pointer;
      background: none;
      color: white;
      transition: transform 0.5s;
      outline: none;
    }
    #settingsToggle:hover {
      transform: rotate(-360deg);
    }
    /* Settings Panel */
    #settingsPanel {
      position: absolute;
      top: 50px;
      right: 10px;
      background-color: #fff;
      border: 2px solid #007acc;
      border-radius: 12px;
      padding: 10px;
      display: none;
      z-index: 1500;
      min-width: 180px;
      animation: fadeInDown 0.5s;
    }
    #settingsPanel p {
      margin: 5px 0;
      font-family: "Courier New", monospace;
    }
    .speed-option {
      background-color: #e0e0e0;
      border: 2px outset #999;
      color: #000;
      font-family: "Courier New", monospace;
      padding: 5px 10px;
      margin: 3px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.3s;
      outline: none;
    }
    .speed-option.active,
    .speed-option:hover {
      background-color: #d0d0d0;
      transform: scale(1.1);
    }
    /* Navigation Buttons in Settings (vertical layout) */
    #navButtons {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-top: 10px;
    }
    /* Mic Icon for Voice Search */
    .mic-icon {
      background-color: #007acc;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 1.6em;
      padding: 8px;
      margin-left: 5px;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      outline: none;
    }
    .mic-icon:hover {
      transform: scale(1.2);
      box-shadow: 0 0 8px rgba(0,122,204,0.8);
    }
    .mic-icon.listening {
      animation: pulseMic 1s infinite;
    }
    @keyframes pulseMic {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    /* DARK THEME STYLES */
    .dark-theme body {
      background-color: #000;
      color: #DAA520;
    }
    .dark-theme .top-bar {
      background-color: #000;
      border-bottom-color: #DAA520;
      color: #DAA520;
    }
    .dark-theme #app {
      background-color: #000;
      color: #DAA520;
    }
    .dark-theme #app header {
      background-color: #000;
      color: #DAA520;
    }
    .dark-theme #content-section {
      background-color: #111;
      color: #DAA520;
    }
    .dark-theme #search-bar {
      background-color: #333;
      color: #DAA520;
      border-color: #DAA520;
    }
    .dark-theme .old-style-button,
    .dark-theme .top-bar button {
      background-color: gold;
      color: black;
      border: 2px outset #b8860b;
    }
    .dark-theme #settingsPanel {
      background-color: #000;
      border-color: #DAA520;
      color: #DAA520;
    }
    /* Flags */
    .flag-icons img {
      width: 30px;
      vertical-align: middle;
      margin: 0 5px;
    }
    .language-selector {
      margin-top: 10px;
      animation: fadeIn 1s;
    }
    .language-selector label {
      font-size: 1em;
      color: #f9f9f9;
    }
    .language-selector select {
      font-size: 1em;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #2a4d69;
      color: #2a4d69;
      background-color: #fff;
    }
    .search-container {
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInUp 0.8s;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #search-bar {
      width: 90%;
      max-width: 400px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #007acc;
      font-size: 1em;
      text-align: right;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
      transition: background-color 0.5s, border-color 0.5s;
    }
    #search-bar:focus {
      border-color: #005f99;
      outline: none;
    }
    #content-section {
      margin-top: 20px;
      background-color: #f1f1f1;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: 0px 4px 8px rgba(0, 0, 51, 0.3);
      text-align: left;
      transition: background-color 0.5s, color 0.5s;
    }
    #content-section h2 {
      color: #2a4d69;
    }
    #content-section img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
    }
    .full-content {
      padding: 10px;
      margin-top: 10px;
      max-width: 100%;
      overflow-x: auto;
      word-wrap: break-word;
    }
    .full-content img,
    .full-content audio,
    .full-content video {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
    }
    /* CUSTOM GAME CONTROLLER STYLE */
    .custom-controller {
      background-color: #fff;
      border: 2px solid #007acc;
      color: #007acc;
      font-family: "Courier New", monospace;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      box-shadow: 3px 3px 0px #999;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s, transform 0.3s;
      animation: bounce 1s infinite;
    }
    .custom-controller:active {
      transform: scale(0.95);
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    /* AUTHENTICATION STYLES */
    .auth-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f4f4f4;
    }
    .auth-box {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 90%;
      max-width: 350px;
      padding: 15px 20px;
      border-radius: 20px;
      background-color: #ffffff;
      color: #000080;
      border: 1px solid #0000ff;
      animation: fadeIn 1s;
      transition: background-color 0.5s, color 0.5s;
    }
    @media (min-width: 1024px) {
      .form {
        max-width: 600px;
        padding: 10px 40px;
      }
    }
    .title {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -1px;
      padding-left: 30px;
      color: #0000ff;
      position: relative;
    }
    .title::before,
    .title::after {
      content: "";
      position: absolute;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      left: 0;
      background-color: #0000ff;
    }
    .title::after {
      animation: pulse 1s linear infinite;
    }
    .message, .signin {
      font-size: 14.5px;
      color: #000080;
    }
    .signin {
      text-align: center;
    }
    .signin a {
      color: #0000ff;
    }
    .signin a:hover {
      text-decoration: underline;
    }
    .flex {
      display: flex;
      gap: 6px;
      width: 100%;
    }
    .form label {
      position: relative;
    }
    .form label .input {
      background-color: #e6f0ff;
      color: #000080;
      width: 100%;
      padding: 20px 5px 5px 10px;
      border: 1px solid #0000ff;
      border-radius: 10px;
      outline: none;
      transition: background-color 0.5s, border-color 0.5s;
    }
    .form label .input + span {
      color: #000080;
      position: absolute;
      left: 10px;
      top: 0;
      font-size: 0.9em;
      cursor: text;
      transition: 0.3s ease;
    }
    .form label .input:placeholder-shown + span {
      top: 12.5px;
      font-size: 0.9em;
    }
    .form label .input:focus + span,
    .form label .input:valid + span {
      color: #0000ff;
      top: 0;
      font-size: 0.7em;
      font-weight: 600;
    }
    .input {
      font-size: medium;
    }
    .submit {
      border: none;
      padding: 10px;
      border-radius: 10px;
      color: #fff;
      font-size: 16px;
      background-color: #0000ff;
      transition: background-color 0.5s;
    }
    .submit:hover {
      background-color: #0000e6;
    }
    @keyframes pulse {
      from { transform: scale(0.9); opacity: 1; }
      to { transform: scale(1.8); opacity: 0; }
    }
    /* Mobile responsiveness tweaks */
    @media (max-width: 600px) {
      #app header h1 { font-size: 1.8em; }
      #app header p { font-size: 1em; }
      #search-bar { width: 80%; padding: 12px; }
      #content-section { padding: 15px; }
      .controls button { width: 50px; height: 50px; font-size: 1.2rem; }
      .custom-controller { width: 50px; height: 50px; font-size: 1.2rem; }
    }
    /* Dark mode for auth form */
    .dark-theme .form {
      background-color: #000;
      color: gold;
      border: 1px solid gold;
    }
    .dark-theme .form .input {
      background-color: #333;
      color: gold;
      border-color: gold;
    }
    .dark-theme .submit {
      background-color: gold;
      color: black;
      border: 2px outset #b8860b;
    }
    /* Search History Section */
    #history {
      background-color: #f1f1f1;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0, 0, 51, 0.3);
      text-align: left;
      transition: background-color 0.5s, color 0.5s;
    }
    #history h2 {
      color: #2a4d69;
      margin-bottom: 10px;
    }
    #history input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #007acc;
    }
    #history ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #history li {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    #history li:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <!-- TOP NAVIGATION BAR -->
  <div class="top-bar">
    <button id="btnApp" class="old-style-button" onclick="showSection('app')">التطبيق</button>
    <button id="btnGame" class="old-style-button" onclick="window.location.href='game.html'">اللعبة</button>
    <button id="btnAuth" class="old-style-button" onclick="showSection('auth')">تسجيل</button>
  </div>
  <!-- AUTH SECTION -->
  <div id="auth" class="section">
    <div class="auth-container">
      <div class="auth-box">
        <div id="authSection">
          <!-- SIGNUP FORM -->
          <form class="form" id="signupForm">
            <p id="signupTitle" class="title">إنشاء حساب</p>
            <p id="signupMessage" class="message">أنشئ حسابك وتمكن من التطبيق</p>
            <div class="flex">
              <label>
                <input class="input" type="text" id="firstname" placeholder="الاسم الأول" required>
                <span></span>
              </label>
              <label>
                <input class="input" type="text" id="lastname" placeholder="الاسم الثاني" required>
                <span></span>
              </label>
            </div>
            <label>
              <input class="input" type="email" id="email" placeholder="البريد الإلكتروني" required>
              <span></span>
            </label>
            <label>
              <input class="input" type="password" id="password" placeholder="رقم المرور" required>
              <span></span>
            </label>
            <label>
              <input class="input" type="password" id="confirmPassword" placeholder="تأكيد رقم المرور" required>
              <span></span>
            </label>
            <button type="button" class="submit" onclick="signup()">إنشاء</button>
            <p class="signin">هل لديك حساب بالفعل؟ 
              <a href="#" onclick="showSignin()">تسجيل الدخول</a>
            </p>
          </form>
          <!-- SIGNIN FORM -->
          <form class="form" id="signinForm" style="display: none;">
            <p id="signinTitle" class="title">تسجيل الدخول</p>
            <p id="signinMessage" class="message">مرحبًا من جديد! يرجى تسجيل الدخول للتمكن من التطبيق</p>
            <label>
              <input class="input" type="email" id="signinEmail" placeholder="البريد الإلكتروني" required>
              <span></span>
            </label>
            <label>
              <input class="input" type="password" id="signinPassword" placeholder="رقم المرور" required>
              <span></span>
            </label>
            <button type="button" class="submit" onclick="signin()">سجل الدخول</button>
            <p class="signin">ليس لديك حساب؟  
              <a href="#" onclick="showSignup()">إنشاء حساب</a>
            </p>
          </form>
          <!-- LOGOUT OPTION -->
          <div id="logoutOption" style="display: none;">
            <p id="logoutMessage">أنت مسجل</p>
            <button class="submit" onclick="logout()">تسجيل الخروج</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- APP SECTION -->
  <div id="app" class="section">
    <header>
      <button id="themeToggle" onclick="toggleTheme()">🌙</button>
      <button id="settingsToggle" class="old-style-button">⚙</button>
      <!-- Settings Panel -->
      <div id="settingsPanel">
        <p id="settingsText">سرعة القراءة:</p>
        <div id="userInfo" style="margin-bottom:8px;"></div>
        <button class="speed-option" data-speed="0.5">0.5x</button>
        <button class="speed-option active" data-speed="1">1x</button>
        <button class="speed-option" data-speed="1.5">1.5x</button>
        <button class="speed-option" data-speed="2">2x</button>
        <!-- Navigation Buttons (vertical layout) -->
        <div id="navButtons">
          <button id="navChatbot" class="old-style-button" onclick="window.location.href='chatbot.html'">الدردشة</button>
          <button id="navAbout" class="old-style-button" onclick="window.location.href='about me.html'">عني</button>
          <button id="navVideos" class="old-style-button" onclick="window.location.href='videos.html'">فيديوهات</button>
          <button id="navHistory" class="old-style-button" onclick="checkHistoryAccess()">سجل البحث</button>
        </div>
      </div>
      <div id="top-message">
        <span>Free Palestine فلسطين في القلب</span>
        <div class="flag-icons">
          <img src="https://upload.wikimedia.org/wikipedia/commons/0/00/Flag_of_Palestine.svg" alt="Palestine Flag">
          <img src="https://upload.wikimedia.org/wikipedia/commons/f/fe/Flag_of_Egypt.svg" alt="Egypt Flag">
        </div>
      </div>
      <h1 id="main-title">موسوعة الحضارة المصرية</h1>
      <p id="main-subtitle">مصر - تاريخ، حضارة، وثقافة</p>
      <div class="language-selector">
        <label for="language" id="language-label">اختر اللغة:</label>
        <select id="language" onchange="changeLanguage()">
          <option value="ar">العربية</option>
          <option value="en">English</option>
          <option value="de">Deutsch</option>
          <option value="fr">Français</option>
          <option value="es">Español</option>
        </select>
      </div>
    </header>
    <main>
      <section class="introduction">
        <h2 id="introduction-title">لمحة عن الحضارة المصرية القديمة</h2>
        <div class="search-container">
          <input type="text" id="search-bar" placeholder="ابحث عن التاريخ المصري...">
          <button id="search-button" class="old-style-button" onclick="fetchContent()">ابحث</button>
          <button id="voiceSearchBtn" class="mic-icon" title="بحث صوتي">🎤</button>
        </div>
      </section>
      <section id="content-section">
        <!-- محتوى ويكيبيديا سيتم تحميله هنا -->
      </section>
      <!-- قسم سجل البحث -->
      <section id="history" class="section">
        <h2>سجل البحث</h2>
        <input type="text" id="historyFilter" placeholder="ابحث في السجل...">
        <ul id="historyList"></ul>
      </section>
    </main>
    <footer>
      <p>جميع الحقوق محفوظة &copy; 2024 - موسوعة الحضارة المصرية</p>
    </footer>
  </div>
  <script>
    // -------------------- Global Variables and Translations --------------------
    let fullArticleDisplayed = false;
    let currentLanguage = 'ar';
    let searchResults = [];
    let speechSynthesisInstance = null;
    let currentArticleTitle = "";
    let currentArticleExtract = "";
    let readerSpeed = 1;
    const YOUTUBE_API_KEY = "AIzaSyCe3BZbOsFYE4HtHU2n1AgGqFCNORciGks";
    const translations = {
      ar: {
        mainTitle: "موسوعة الحضارة المصرية",
        mainSubtitle: "مصر - تاريخ، حضارة، وثقافة",
        searchPlaceholder: "ابحث عن التاريخ المصري...",
        searchButton: "ابحث",
        readMore: "عرض المزيد",
        readLess: "عرض أقل",
        listenArticle: "استمع إلى المقال",
        stopListening: "أوقف القراءة",
        noResults: "لا توجد نتائج",
        topBar: { app: "التطبيق", game: "اللعبة", auth: "تسجيل", highScore: "أعلى نتيجة" },
        signupTitle: "إنشاء حساب",
        signupMessage: "تم التسجيل بنجاح!",
        signinTitle: "تسجيل الدخول",
        signinMessage: "مرحبًا من جديد! تم تسجيل الدخول.",
        logoutMessage: "أنت مسجل",
        settingsText: "سرعة القراءة:",
        navChatbot: "الدردشة",
        navAbout: "عني",
        navVideos: "فيديوهات",
        navHistory: "سجل البحث"
      },
      en: {
        mainTitle: "Egyptian Civilization Encyclopedia",
        mainSubtitle: "Egypt - History, Civilization, and Culture",
        searchPlaceholder: "Search for Egyptian history...",
        searchButton: "Search",
        readMore: "Show more",
        readLess: "Show less",
        listenArticle: "Listen to the article",
        stopListening: "Stop Listening",
        noResults: "No results found",
        topBar: { app: "App", game: "Game", auth: "Auth", highScore: "High Score" },
        signupTitle: "Sign Up",
        signupMessage: "You're registered!",
        signinTitle: "Sign In",
        signinMessage: "Welcome back! You're signed in.",
        logoutMessage: "You are logged in",
        settingsText: "Reader Speed:",
        navChatbot: "Chatbot",
        navAbout: "About Me",
        navVideos: "Videos",
        navHistory: "Search History"
      },
      de: {
        mainTitle: "Enzyklopädie der ägyptischen Zivilisation",
        mainSubtitle: "Ägypten – Geschichte, Zivilisation und Kultur",
        searchPlaceholder: "Suche nach ägyptischer Geschichte...",
        searchButton: "Suchen",
        readMore: "Mehr anzeigen",
        readLess: "Weniger anzeigen",
        listenArticle: "Artikel anhören",
        stopListening: "Anhalten",
        noResults: "Keine Ergebnisse gefunden",
        topBar: { app: "App", game: "Spiel", auth: "Anmeldung", highScore: "Bestpunktzahl" },
        signupTitle: "Registrieren",
        signupMessage: "Du bist registriert!",
        signinTitle: "Anmelden",
        signinMessage: "Willkommen zurück! Du bist angemeldet.",
        logoutMessage: "Du bist angemeldet",
        settingsText: "Lesegeschwindigkeit:",
        navChatbot: "Chatbot",
        navAbout: "Über mich",
        navVideos: "Videos",
        navHistory: "Suchverlauf"
      },
      fr: {
        mainTitle: "Encyclopédie de la civilisation égyptienne",
        mainSubtitle: "Égypte – Histoire, civilisation et culture",
        searchPlaceholder: "Recherchez l'histoire égyptienne...",
        searchButton: "Rechercher",
        readMore: "Afficher plus",
        readLess: "Afficher moins",
        listenArticle: "Écouter l'article",
        stopListening: "Arrêter",
        noResults: "Aucun résultat trouvé",
        topBar: { app: "Application", game: "Jeu", auth: "Authentification", highScore: "Meilleur score" },
        signupTitle: "S'inscrire",
        signupMessage: "Vous êtes inscrit(e)!",
        signinTitle: "Se connecter",
        signinMessage: "Bon retour ! Vous êtes connecté(e).",
        logoutMessage: "Vous êtes connecté(e)",
        settingsText: "Vitesse de lecture:",
        navChatbot: "Chatbot",
        navAbout: "À propos de moi",
        navVideos: "Vidéos",
        navHistory: "Historique de recherche"
      },
      es: {
        mainTitle: "Enciclopedia de la Civilización Egipcia",
        mainSubtitle: "Egipto - Historia, Civilización y Cultura",
        searchPlaceholder: "Busca la historia de Egipto...",
        searchButton: "Buscar",
        readMore: "Mostrar más",
        readLess: "Mostrar menos",
        listenArticle: "Escuchar el artículo",
        stopListening: "Detener",
        noResults: "No se encontraron resultados",
        topBar: { app: "Aplicación", game: "Juego", auth: "Autenticación", highScore: "Mejor puntuación" },
        signupTitle: "Registrarse",
        signupMessage: "¡Te has registrado!",
        signinTitle: "Iniciar sesión",
        signinMessage: "¡Bienvenido de nuevo! Has iniciado sesión.",
        logoutMessage: "Estás conectado",
        settingsText: "Velocidad de lectura:",
        navChatbot: "Chatbot",
        navAbout: "Acerca de mí",
        navVideos: "Videos",
        navHistory: "Historial de búsqueda"
      }
    };

    // -------------------- Language Update Function --------------------
    function updateLanguageTexts() {
      const trans = translations[currentLanguage];
      document.getElementById('main-title').textContent = trans.mainTitle;
      document.getElementById('main-subtitle').textContent = trans.mainSubtitle;
      document.getElementById('search-bar').placeholder = trans.searchPlaceholder;
      document.getElementById('search-button').textContent = trans.searchButton;
      document.getElementById('settingsText').textContent = trans.settingsText;
      // Top bar buttons
      document.getElementById('btnApp').textContent = trans.topBar.app;
      document.getElementById('btnGame').textContent = trans.topBar.game;
      document.getElementById('btnAuth').textContent = trans.topBar.auth;
      // Auth forms
      document.getElementById('signupTitle').textContent = trans.signupTitle;
      document.getElementById('signupMessage').textContent = trans.signupMessage;
      document.getElementById('signinTitle').textContent = trans.signinTitle;
      document.getElementById('signinMessage').textContent = trans.signinMessage;
      document.getElementById('logoutMessage').textContent = trans.logoutMessage;
      // Update high score text
      document.getElementById('highScoreDisplay').textContent = `${trans.topBar.highScore}: ${localStorage.getItem('highScore') || 0}`;
      // If settings panel is open, update its text
      const settingsPanel = document.getElementById('settingsPanel');
      if(settingsPanel.style.display !== 'none') {
        settingsPanel.querySelector('p').textContent = trans.settingsText;
      }
      // Update player label (if applicable)
      player.label = currentLanguage === 'en' ? "Egypt" : (currentLanguage === 'de' ? "Ägypten" : (currentLanguage === 'fr' ? "Égypte" : (currentLanguage === 'es' ? "Egipto" : "مصر")));
      // تحديث نصوص أزرار التنقل في لوحة الإعدادات
      document.getElementById('navChatbot').textContent = trans.navChatbot;
      document.getElementById('navAbout').textContent = trans.navAbout;
      document.getElementById('navVideos').textContent = trans.navVideos;
      document.getElementById('navHistory').textContent = trans.navHistory;
    }

    // -------------------- Check Login State on Load --------------------
    function checkLoginState() {
      const storedName = localStorage.getItem('userName');
      const storedEmail = localStorage.getItem('userEmail');
      if(storedName && storedEmail) {
        document.getElementById('signupForm').style.display = 'none';
        document.getElementById('signinForm').style.display = 'none';
        document.getElementById('logoutOption').style.display = 'block';
      } else {
        document.getElementById('signupForm').style.display = 'block';
        document.getElementById('signinForm').style.display = 'none';
        document.getElementById('logoutOption').style.display = 'none';
      }
    }

    // -------------------- Theme Toggle --------------------
    let isDarkTheme = false;
    function toggleTheme() {
      const htmlEl = document.documentElement;
      const themeBtn = document.getElementById("themeToggle");
      isDarkTheme = !isDarkTheme;
      if(isDarkTheme) {
        htmlEl.classList.add("dark-theme");
        themeBtn.textContent = "☀️";
      } else {
        htmlEl.classList.remove("dark-theme");
        themeBtn.textContent = "🌙";
      }
    }

    // -------------------- Settings Panel --------------------
    function toggleSettingsPanel() {
      const panel = document.getElementById('settingsPanel');
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
      if(panel.style.display === 'block') {
        const userInfo = document.getElementById('userInfo');
        const storedName = localStorage.getItem('userName');
        const storedEmail = localStorage.getItem('userEmail');
        if(storedName && storedEmail) {
          userInfo.innerHTML = `<p>${storedName} - ${storedEmail}</p>`;
        } else {
          userInfo.innerHTML = '';
        }
      }
    }
    document.getElementById('settingsToggle').addEventListener('click', function(e){
      e.stopPropagation();
      toggleSettingsPanel();
    });
    document.addEventListener('click', function(e){
      const panel = document.getElementById('settingsPanel');
      const toggle = document.getElementById('settingsToggle');
      if(panel.style.display === 'block' && !panel.contains(e.target) && e.target !== toggle) {
        panel.style.display = 'none';
      }
    });
    document.querySelectorAll('.speed-option').forEach(btn => {
      btn.addEventListener('click', function(e){
        readerSpeed = parseFloat(this.getAttribute('data-speed'));
        document.querySelectorAll('.speed-option').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        if(speechSynthesisInstance) {
          speechSynthesisInstance.rate = readerSpeed;
        }
        document.getElementById('settingsPanel').style.display = 'none';
        e.stopPropagation();
      });
    });

    // -------------------- Voice Search --------------------
    const voiceSearchBtn = document.getElementById('voiceSearchBtn');
    let recognition;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = currentLanguage === 'ar' ? 'ar-EG' : 'en-US';
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.onstart = () => {
        voiceSearchBtn.classList.add("listening");
      };
      recognition.onend = () => {
        voiceSearchBtn.classList.remove("listening");
      };
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('search-bar').value = transcript;
        fetchContent(transcript);
      };
    } else {
      voiceSearchBtn.style.display = 'none';
    }
    voiceSearchBtn.addEventListener('pointerup', function(e){
      e.stopPropagation();
      if(recognition) {
        recognition.lang = currentLanguage === 'ar' ? 'ar-EG' : (currentLanguage === 'de' ? 'de-DE' : (currentLanguage === 'fr' ? 'fr-FR' : (currentLanguage === 'es' ? 'es-ES' : 'en-US')));
        recognition.start();
      }
    });

    // -------------------- Search History Functions --------------------
    function addSearchHistory(query) {
      if(!query) return;
      const history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
      history.push({ query: query, date: new Date().toLocaleString() });
      localStorage.setItem("searchHistory", JSON.stringify(history));
    }
    function getSearchHistory() {
      return JSON.parse(localStorage.getItem("searchHistory") || "[]");
    }
    function displaySearchHistory(filter = "") {
      const historyList = document.getElementById("historyList");
      historyList.innerHTML = "";
      const history = getSearchHistory();
      const filtered = history.filter(item => item.query.toLowerCase().includes(filter.toLowerCase()));
      filtered.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.query} - ${item.date}`;
        li.addEventListener("click", function() {
          document.getElementById("search-bar").value = item.query;
          fetchContent(item.query);
          showSection("app");
        });
        historyList.appendChild(li);
      });
    }
    document.getElementById("historyFilter").addEventListener("input", function() {
      displaySearchHistory(this.value);
    });
    // إذا لم يقم المستخدم بتسجيل الدخول عند النقر على سجل البحث، فتح قسم التسجيل
    function checkHistoryAccess() {
      const user = localStorage.getItem("userName");
      if(user) {
        showSection("history");
        displaySearchHistory();
      } else {
        showSection("auth");
      }
    }

    // -------------------- Game Control (اختياري إذا كانت اللعبة موجودة في الموقع) --------------------
    let gameActive = false;
    let gameAnimationFrameId = null;
    let enemyInterval = null;
    let highScore = localStorage.getItem('highScore') || 0;
    function updateHighScore() {
      if(score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
        const trans = translations[currentLanguage];
        document.getElementById('highScoreDisplay').textContent = `${trans.topBar.highScore}: ${highScore}`;
      }
    }
    function toggleGamePause() {
      if (gameActive) {
        pauseGame();
        document.getElementById("toggleGameBtn").textContent = currentLanguage === 'en' ? "Start Game" : "تشغيل اللعبة";
      } else {
        startGame();
        document.getElementById("toggleGameBtn").textContent = currentLanguage === 'en' ? "Pause Game" : "إيقاف اللعبة";
      }
    }
    function startGame() {
      if (!gameActive) {
        gameActive = true;
        enemyInterval = setInterval(createEnemy, 2000);
        gameLoop();
      }
    }
    function pauseGame() {
      if (gameActive) {
        cancelAnimationFrame(gameAnimationFrameId);
        clearInterval(enemyInterval);
        gameActive = false;
      }
    }

    // -------------------- Language Change and UI Update --------------------
    function changeLanguage() {
      const languageSelect = document.getElementById("language");
      currentLanguage = languageSelect.value;
      updateLanguageTexts();
      if(recognition) {
        recognition.lang = currentLanguage === 'ar' ? 'ar-EG' : (currentLanguage === 'de' ? 'de-DE' : (currentLanguage === 'fr' ? 'fr-FR' : (currentLanguage === 'es' ? 'es-ES' : 'en-US')));
      }
      fetchContent("الحضارة المصرية");
    }

    // -------------------- Section Navigation --------------------
    function showSection(sectionId) {
      const currentActive = document.querySelector('.section.active');
      if (currentActive && currentActive.id === 'game' && sectionId !== 'game') {
        pauseGame();
      }
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      if (sectionId === 'game' && !gameActive) {
        startGame();
        document.getElementById("toggleGameBtn").textContent = currentLanguage === 'en' ? "Pause Game" : "إيقاف اللعبة";
      }
      if(sectionId === 'history'){
        displaySearchHistory();
      }
    }

    // -------------------- Auth Functions --------------------
    function showSignup() {
      document.getElementById('signupForm').style.display = 'block';
      document.getElementById('signinForm').style.display = 'none';
      document.getElementById('logoutOption').style.display = 'none';
    }
    function showSignin() {
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('signinForm').style.display = 'block';
      document.getElementById('logoutOption').style.display = 'none';
    }
    function signup() {
      const firstName = document.getElementById('firstname').value;
      const lastName = document.getElementById('lastname').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      if (password !== confirmPassword) {
        alert(currentLanguage === 'en' ? "Passwords do not match!" : "كلمات المرور غير متطابقة!");
        return;
      }
      const userName = firstName + " " + lastName;
      localStorage.setItem('userName', userName);
      localStorage.setItem('userEmail', email);
      alert(translations[currentLanguage].signupMessage);
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('signinForm').style.display = 'none';
      document.getElementById('logoutOption').style.display = 'block';
    }
    function signin() {
      const email = document.getElementById('signinEmail').value;
      const password = document.getElementById('signinPassword').value;
      if (password.trim() === '') {
        alert(currentLanguage === 'en' ? "Please enter your password!" : "الرجاء إدخال كلمة المرور!");
        return;
      }
      const storedEmail = localStorage.getItem('userEmail');
      if(email === storedEmail) {
        alert(translations[currentLanguage].signinMessage);
        document.getElementById('signupForm').style.display = 'none';
        document.getElementById('signinForm').style.display = 'none';
        document.getElementById('logoutOption').style.display = 'block';
      } else {
        alert(currentLanguage === 'en' ? "User not found!" : "المستخدم غير موجود!");
      }
    }
    function logout() {
      alert(currentLanguage === 'en' ? "Logged out!" : "لقد تم تسجيل الخروج!");
      document.getElementById('logoutOption').style.display = 'none';
      localStorage.removeItem('userName');
      localStorage.removeItem('userEmail');
      document.getElementById('userInfo').innerHTML = "";
      showSignin();
    }
    // -------------------- Wikipedia & YouTube Integration --------------------
    function fetchContent(query = null) {
      const searchQuery = query || document.getElementById("search-bar").value.trim() || "الحضارة المصرية";
      addSearchHistory(searchQuery);
      const wikiApiUrl = `https://${currentLanguage}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(searchQuery)}&format=json&origin=*`;
      fetch(wikiApiUrl)
        .then(response => response.json())
        .then(data => {
          searchResults = data.query.search;
          displayContent();
          fetchYouTubeVideo(searchQuery);
        })
        .catch(error => {
          console.error("Error fetching data:", error);
        });
    }
    function displayContent() {
      if (searchResults.length === 0) {
        document.getElementById("content-section").innerHTML = `<p>${translations[currentLanguage].noResults}</p>`;
        return;
      }
      const result = searchResults[0];
      fetchPageContent(result.title);
    }
    function fetchPageContent(title) {
      currentArticleTitle = title;
      const wikiApiUrl = `https://${currentLanguage}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
      fetch(wikiApiUrl)
        .then(response => response.json())
        .then(data => {
          currentArticleExtract = data.extract;
          document.getElementById("content-section").innerHTML = `
            <h2>${data.title}</h2>
            <p>${data.extract}</p>
            ${data.thumbnail ? `<img src="${data.thumbnail.source}" alt="${data.title}">` : ''}
            <div id="fullArticleContainer"></div>
            <button id="readMoreBtn" class="old-style-button" onclick="toggleFullArticle('${data.title}')">${translations[currentLanguage].readMore}</button>
            <button id="speechBtn" class="old-style-button" onclick="toggleSpeech('${data.extract.replace(/'/g, "\\'")}')">${translations[currentLanguage].listenArticle}</button>
            <div id="youtube-video"></div>
          `;
          fullArticleDisplayed = false;
          interceptArticleLinks();
        })
        .catch(error => {
          console.error("Error fetching page content:", error);
        });
    }
    async function toggleFullArticle(title) {
      const container = document.getElementById("fullArticleContainer");
      const btn = document.getElementById("readMoreBtn");
      if (fullArticleDisplayed) {
        container.innerHTML = "";
        btn.textContent = translations[currentLanguage].readMore;
        fullArticleDisplayed = false;
      } else {
        const wikiApiUrl = `https://${currentLanguage}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&format=json&origin=*`;
        try {
          const response = await fetch(wikiApiUrl);
          const data = await response.json();
          let fullContentHtml = data.parse.text['*'];
          fullContentHtml = fullContentHtml.replace(/src="\/\/(.*?)"/g, 'src="https://$1"');
          fullContentHtml = fullContentHtml.replace(/data-src="\/\/(.*?)"/g, 'data-src="https://$1"');
          container.innerHTML = `<div class="full-content">${fullContentHtml}</div>`;
          container.querySelectorAll('audio').forEach(audio => audio.setAttribute('controls', true));
          container.querySelectorAll('video').forEach(video => video.setAttribute('controls', true));
          container.querySelectorAll('img').forEach(img => {
            img.style.maxWidth = "100%";
            img.style.height = "auto";
            img.style.display = "block";
            if(img.hasAttribute('data-src')){
              img.src = img.getAttribute('data-src');
            }
          });
          btn.textContent = translations[currentLanguage].readLess;
          fullArticleDisplayed = true;
          interceptArticleLinks();
        } catch (error) {
          console.error("Error fetching full page content:", error);
        }
      }
    }
    function interceptArticleLinks() {
      const container = document.getElementById("fullArticleContainer");
      if (!container) return;
      container.querySelectorAll("a").forEach(link => {
        link.style.color = "#007acc";
        link.addEventListener("click", function(e) {
          e.preventDefault();
          const newTopic = this.innerText.trim();
          if(newTopic) {
            document.getElementById("search-bar").value = newTopic;
            fetchContent(newTopic);
            showSection("app");
          }
        });
      });
    }
    function toggleSpeech(text) {
      const speechBtn = document.getElementById("speechBtn");
      if (speechSynthesisInstance && speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        speechSynthesisInstance = null;
        speechBtn.textContent = translations[currentLanguage].listenArticle;
        return;
      }
      let voices = window.speechSynthesis.getVoices();
      let selectedVoice = voices.find(voice => voice.lang.startsWith(currentLanguage === 'ar' ? 'ar' : (currentLanguage === 'es' ? 'es' : 'en')));
      speechSynthesisInstance = new SpeechSynthesisUtterance(text);
      if (selectedVoice) {
        speechSynthesisInstance.voice = selectedVoice;
      }
      speechSynthesisInstance.lang = currentLanguage === 'ar' ? 'ar-EG' : (currentLanguage === 'de' ? 'de-DE' : (currentLanguage === 'fr' ? 'fr-FR' : (currentLanguage === 'es' ? 'es-ES' : 'en-US')));
      speechSynthesisInstance.rate = readerSpeed;
      window.speechSynthesis.speak(speechSynthesisInstance);
      speechBtn.textContent = translations[currentLanguage].stopListening;
    }
    function fetchYouTubeVideo(query) {
      if(query.trim().toLowerCase() === "egypt") {
        query = "Egypt history";
      }
      const youtubeApiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}&type=video&maxResults=1`;
      fetch(youtubeApiUrl)
        .then(response => response.json())
        .then(data => {
          if (data.items && data.items.length > 0) {
            const video = data.items[0];
            displayYouTubeVideo(video);
          } else {
            document.getElementById("youtube-video").innerHTML = `<p>${translations[currentLanguage].noResults}</p>`;
          }
        })
        .catch(error => {
          console.error("Error fetching YouTube video:", error);
        });
    }
    function displayYouTubeVideo(video) {
      document.getElementById("youtube-video").innerHTML = `
        <div class="video-player">
          <iframe width="100%" height="315" src="https://www.youtube.com/embed/${video.id.videoId}" 
          frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
          allowfullscreen></iframe>
          <p>${video.snippet.title}</p>
        </div>
      `;
    }
    document.getElementById("search-bar").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        fetchContent();
      }
    });
    window.speechSynthesis.onvoiceschanged = () => {
      window.speechSynthesis.getVoices();
    };
    document.addEventListener("DOMContentLoaded", () => {
      checkLoginState();
      showSection("app");
      window.speechSynthesis.getVoices();
      fetchContent("الحضارة المصرية");
      updateLanguageTexts();
      document.getElementById('highScoreDisplay').textContent = `${translations[currentLanguage].topBar.highScore}: ${localStorage.getItem('highScore') || 0}`;
    });
  </script>
</body>
</html>
